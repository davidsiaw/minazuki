# frozen_string_literal: true

# Description of the <%= name.to_s.camelize %> model
<% resource.fields.each do |field_name, field| %>
# @!attribute <%= field_name %>
#   @return [<%= field[:type].to_s.camelize %>] Description of this attribute
<% end -%>
class <%= name.to_s.camelize %> < ApplicationRecord
  has_paper_trail

  <% resource.fields.each do |field_name, field| %>
  <%   unless %i[string integer].include? field[:type] %>
  ulid :<%= field_name %>_id
  belongs_to :<%= field_name %>, class_name: '<%= field[:type].to_s.camelize %>', foreign_key: :<%= field_name %>_id
  <%   end -%>
  <% end -%>

  <% resource.parent_names.each do |parent| %>
  belongs_to :<%= parent %>, autosave: true
  <% end %>

  <% resource.parent_fields.each do |parent, fields| %>
  delegate \
  <%- fields.each do |field_name, field| -%>
    :<%= field_name %>,
    :<%= field_name %>=,
    <% unless %i[string integer].include? field[:type] %>
    :<%= field_name %>_id,
    :<%= field_name %>_id=,
    <% end %>
  <%- end -%>
    to: :make_<%= parent %>

  ulid :<%= parent %>_id
  after_initialize :make_<%= parent %>
  before_validation :save_<%= parent %>

  def make_<%= parent %>
    self.<%= parent %> ||= <%= parent.to_s.camelize %>.new
  end

  def save_<%= parent %>
    self.<%= parent %>.save!
  end
  <% end -%>

  scope :ordered_by, ->(attrib, direction) do
  <% resource.parent_fields.each do |parent, fields| %>
    if %i[<%= fields.keys.select { |k| %i[string integer].include?(fields[k][:type]) }.join(' ') %>].include? attrib
      return joins(:<%= parent %>).merge(<%= parent.to_s.camelize %>.ordered_by(attrib, direction))
    end
  <%- end -%>

    order(attrib.to_sym => direction.to_sym)
  end
end
