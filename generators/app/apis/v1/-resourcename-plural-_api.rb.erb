# frozen_string_literal: true

module V1
  # Endpoint to access <%= name.to_s.pluralize.humanize %>
  class <%= name.to_s.pluralize.camelize %>Api < Grape::API
    resource :<%= name.to_s.pluralize %> do
      desc 'Get <%= name.to_s.pluralize.humanize %>'
      params do
        optional :page, type: Integer
        optional :count, type: Integer
        optional :sort, type: Symbol, values: %i[id <%= resource.fields.map { |n, _| n }.join(' ') %>], default: :id
        optional :order, type: Symbol, values: %i[asc desc], default: :asc
      end
      get do
        count = params[:count] || 20
        page = params[:page] || 1
        page = [1, page].max
        count = [1, count].max
        count = [count, 50].min
        result = <%= name.to_s.camelize %>.limit(count).offset((page - 1) * count)
        result = result.order("#{params[:sort]} #{params[:order].upcase}")
        sort = params[:sort]
        order = params[:order]
        {
          page: page,
          count: count,
          sort: sort,
          order: order,
          results: result
        }
      end

      desc 'Create a new <%= name.to_s.humanize %>'
      params do
        <% resource.fields.each do |field_name, field| %>
        requires :<%= field_name %>, type: <%= field[:type].to_s.camelize %>
        <% end %>
      end
      post do
        { result: <%= name.to_s.camelize %>.create(params) }
      end

      params do
        requires :id, type: String, desc: 'ID of <%= name.to_s.humanize %>'
      end
      route_param :id do
        before do
          @item = <%= name.to_s.camelize %>.find_by(id: params[:id])
          error!({ error: :not_found }, 404) if @item.nil?
        end

        desc 'Get a <%= name.to_s.humanize %>'
        get do
          { result: @item }
        end

        desc 'Change a <%= name.to_s.humanize %>'
        patch do
          { result: :ok }
        end

        desc 'Delete a <%= name.to_s.humanize %>'
        delete do
          @item.destroy!
          { result: :ok }
        end

        <% resource.fields.each do |field_name, field| %>
        resource :<%= field_name %> do
          desc 'Get the <%= field_name.to_s.humanize %> of the <%= name.to_s.humanize %>'
          get do
            {
              result: @item.name
            }
          end

          desc 'Set the <%= field_name.to_s.humanize %> of the <%= name.to_s.humanize %>'
          params do
            requires :value, type: <%= field[:type].to_s.camelize %>
          end
          put do
            @item.<%= field_name %> = params[:value]
            @item.save!
            {
              result: @item.name
            }
          end
        end
        <% end %>
      end
    end
  end
end
